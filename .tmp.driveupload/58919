# file: inventory/models.py

from django.db import models
from django.conf import settings
from django.utils import timezone
from clients.models import MucTieu
from users.models import NhanVien

# Dòng "from .models import ..." đã được xóa bỏ khỏi đây

class LoaiVatTu(models.Model):
    ten_loai = models.CharField("Tên loại vật tư", max_length=100, unique=True)

    class Meta:
        verbose_name = "Loại vật tư"
        verbose_name_plural = "Danh mục Loại vật tư"

    def __str__(self):
        return self.ten_loai

class NhaCungCap(models.Model):
    ten_nha_cung_cap = models.CharField("Tên nhà cung cấp", max_length=255)
    dia_chi = models.CharField("Địa chỉ", max_length=255, blank=True)
    so_dien_thoai = models.CharField("Số điện thoại", max_length=20, blank=True)
    email = models.EmailField("Email", blank=True)

    class Meta:
        verbose_name = "Nhà cung cấp"
        verbose_name_plural = "Danh sách Nhà cung cấp"

    def __str__(self):
        return self.ten_nha_cung_cap

class VatTu(models.Model):
    TRANG_THAI_CHOICES = [
        ('SAN_SANG', 'Sẵn sàng'),
        ('YEU_CAU_NHAP', 'Yêu cầu nhập'),
        ('HET_HANG', 'Hết hàng'),
    ]
    
    ten_vat_tu = models.CharField("Tên vật tư", max_length=255)
    ma_vat_tu = models.CharField("Mã vật tư", max_length=50, unique=True, blank=True, null=True)
    loai = models.ForeignKey(LoaiVatTu, on_delete=models.SET_NULL, null=True, verbose_name="Loại vật tư")
    don_vi_tinh = models.CharField("Đơn vị tính", max_length=50)
    so_luong_ton = models.PositiveIntegerField("Số lượng tồn", default=0)
    dinh_muc_toi_thieu = models.PositiveIntegerField("Định mức tồn tối thiểu", default=0)
    vi_tri_luu_kho = models.CharField("Vị trí lưu kho", max_length=100, blank=True)
    nha_cung_cap = models.ForeignKey(NhaCungCap, on_delete=models.SET_NULL, null=True, blank=True, verbose_name="Nhà cung cấp")
    ngay_nhap = models.DateField("Ngày nhập cuối", null=True, blank=True)
    han_su_dung = models.DateField("Hạn sử dụng", null=True, blank=True)
    trang_thai = models.CharField("Trạng thái", max_length=20, choices=TRANG_THAI_CHOICES, default='SAN_SANG')
    hinh_anh = models.ImageField("Hình ảnh", upload_to='vat_tu/', null=True, blank=True)
    ghi_chu = models.TextField("Ghi chú", blank=True)

    class Meta:
        verbose_name = "Vật tư"
        verbose_name_plural = "Danh sách Vật tư"

    def __str__(self):
        return self.ten_vat_tu

class PhieuNhap(models.Model):
    vat_tu = models.ForeignKey(VatTu, on_delete=models.CASCADE, verbose_name="Vật tư")
    so_luong = models.PositiveIntegerField("Số lượng nhập")
    don_gia = models.DecimalField("Đơn giá", max_digits=10, decimal_places=0)
    nguoi_nhap = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.SET_NULL, null=True, verbose_name="Người nhập")
    ngay_nhap = models.DateTimeField("Ngày nhập", auto_now_add=True)

    class Meta:
        verbose_name = "Phiếu nhập kho"
        verbose_name_plural = "Danh sách Phiếu nhập kho"

    def __str__(self):
        return f"Nhập {self.so_luong} {self.vat_tu.don_vi_tinh} {self.vat_tu.ten_vat_tu}"

class PhieuXuat(models.Model):
    vat_tu = models.ForeignKey(VatTu, on_delete=models.CASCADE, verbose_name="Vật tư")
    so_luong = models.PositiveIntegerField("Số lượng xuất")
    nguoi_xuat = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.SET_NULL, null=True, related_name='phieu_xuat_nguoi_xuat', verbose_name="Người xuất")
    muc_tieu = models.ForeignKey(MucTieu, on_delete=models.SET_NULL, null=True, verbose_name="Xuất cho mục tiêu")
    ngay_xuat = models.DateTimeField("Ngày xuất", auto_now_add=True)

    class Meta:
        verbose_name = "Phiếu xuất kho (Mục tiêu)"
        verbose_name_plural = "DS Phiếu xuất kho (Mục tiêu)"

    def __str__(self):
        if self.muc_tieu:
            return f"Xuất {self.so_luong} {self.vat_tu.don_vi_tinh} {self.vat_tu.ten_vat_tu} cho {self.muc_tieu.ten_muc_tieu}"
        return f"Xuất {self.so_luong} {self.vat_tu.don_vi_tinh} {self.vat_tu.ten_vat_tu}"

class PhieuCapPhat(models.Model):
    so_phieu = models.CharField("Số phiếu", max_length=50, unique=True, editable=False)
    nguoi_nhan = models.ForeignKey(NhanVien, on_delete=models.CASCADE, verbose_name="Nhân viên nhận")
    nguoi_cap_phat = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.SET_NULL, null=True, verbose_name="Người cấp phát")
    ngay_cap_phat = models.DateTimeField("Ngày cấp phát", default=timezone.now)
    ghi_chu = models.TextField("Ghi chú", blank=True)

    class Meta:
        verbose_name = "Phiếu Cấp phát Cá nhân"
        verbose_name_plural = "DS Phiếu Cấp phát Cá nhân"

    def __str__(self):
        return self.so_phieu

    def save(self, *args, **kwargs):
        if not self.so_phieu:
            ngay_hien_tai = self.ngay_cap_phat or timezone.now()
            today_str = ngay_hien_tai.strftime('%Y%m%d')
            last_phieu = PhieuCapPhat.objects.filter(so_phieu__startswith=f"PCP-{today_str}").order_by('so_phieu').last()
            if last_phieu:
                last_num = int(last_phieu.so_phieu.split('-')[-1])
                new_num = last_num + 1
            else:
                new_num = 1
            self.so_phieu = f"PCP-{today_str}-{new_num:03d}"
        super().save(*args, **kwargs)

class ChiTietCapPhat(models.Model):
    phieu_cap_phat = models.ForeignKey(PhieuCapPhat, on_delete=models.CASCADE, related_name='chi_tiet')
    vat_tu = models.ForeignKey(VatTu, on_delete=models.CASCADE, verbose_name="Vật tư")
    so_luong = models.PositiveIntegerField("Số lượng")

    def __str__(self):
        return f"{self.so_luong} {self.vat_tu.don_vi_tinh} {self.vat_tu.ten_vat_tu}"

class CapPhatCaNhan(models.Model):
    pass