# file: inventory/admin.py

from django.contrib import admin
from django.utils.html import format_html
from django.urls import reverse
# Import các model cần thiết
from .models import LoaiVatTu, NhaCungCap, VatTu, PhieuNhap, PhieuXuat, PhieuCapPhat, ChiTietCapPhat

@admin.register(LoaiVatTu)
class LoaiVatTuAdmin(admin.ModelAdmin):
    list_display = ('ten_loai',)
    search_fields = ('ten_loai',)

@admin.register(NhaCungCap)
class NhaCungCapAdmin(admin.ModelAdmin):
    list_display = ('ten_nha_cung_cap', 'so_dien_thoai', 'email')
    search_fields = ('ten_nha_cung_cap',)

@admin.register(VatTu)
class VatTuAdmin(admin.ModelAdmin):
    list_display = ('ten_vat_tu', 'ma_vat_tu', 'loai', 'so_luong_ton')
    search_fields = ('ten_vat_tu', 'ma_vat_tu')
    list_filter = ('loai',)

# --- GIAO DIỆN MỚI CHO CHỨC NĂNG CẤP PHÁT (Sử dụng PhieuCapPhat) ---
class ChiTietCapPhatInline(admin.TabularInline):
    model = ChiTietCapPhat
    extra = 1
    autocomplete_fields = ['vat_tu']

@admin.register(PhieuCapPhat)
class PhieuCapPhatAdmin(admin.ModelAdmin):
    inlines = [ChiTietCapPhatInline]
    list_display = ('so_phieu', 'nguoi_nhan', 'nguoi_cap_phat', 'ngay_cap_phat', 'in_phieu')
    list_filter = ('ngay_cap_phat', 'nguoi_nhan')
    search_fields = ('so_phieu', 'nguoi_nhan__ho_ten')
    autocomplete_fields = ['nguoi_nhan']
    readonly_fields = ('so_phieu',)

    def save_model(self, request, obj, form, change):
        if not obj.pk: # Khi tạo mới
            obj.nguoi_cap_phat = request.user
        super().save_model(request, obj, form, change)

    def save_formset(self, request, form, formset, change):
        instances = formset.save(commit=False)
        for instance in instances:
            # Logic trừ kho sẽ được xử lý bằng signals
            instance.save()
        formset.save_m2m()

    @admin.display(description='In Phiếu')
    def in_phieu(self, obj):
        url = reverse('inventory:in_phieu_cap_phat', args=[obj.id])
        return format_html(f'<a href="{url}" class="button" target="_blank">In Phiếu</a>')

# Đăng ký các model còn lại
@admin.register(PhieuNhap)
class PhieuNhapAdmin(admin.ModelAdmin):
    list_display = ('vat_tu', 'so_luong', 'nguoi_nhap', 'ngay_nhap')
    autocomplete_fields = ['vat_tu', 'nguoi_nhap']

@admin.register(PhieuXuat)
class PhieuXuatAdmin(admin.ModelAdmin):
    list_display = ('vat_tu', 'so_luong', 'nguoi_xuat', 'ngay_xuat', 'muc_tieu')
    autocomplete_fields = ['vat_tu', 'nguoi_xuat', 'muc_tieu']

# --- ĐÃ XÓA HOÀN TOÀN LỚP CapPhatCaNhanAdmin GÂY LỖI ---