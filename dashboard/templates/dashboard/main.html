{% extends "base.html" %}
{% load humanize %} {% block title %}Bảng điều khiển{% endblock %}
{% block page_title %}Bảng điều khiển tổng quan{% endblock %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
    
    <div class="stat bg-base-100 shadow rounded-box">
        <div class="stat-figure text-primary">
            <i class="fas fa-users text-3xl"></i>
        </div>
        <div class="stat-title">Nhân viên hoạt động</div>
        <div class="stat-value text-primary">{{ total_nhan_vien|intcomma }}</div>
        <div class="stat-desc">Tổng số nhân sự trong hệ thống</div>
    </div>
    
    <div class="stat bg-base-100 shadow rounded-box">
        <div class="stat-figure text-secondary">
            <i class="fas fa-handshake text-3xl"></i>
        </div>
        <div class="stat-title">Khách hàng</div>
        <div class="stat-value text-secondary">{{ total_khach_hang|intcomma }}</div>
        <div class="stat-desc">Số lượng khách hàng đang hợp tác</div>
    </div>
    
    <div class="stat bg-base-100 shadow rounded-box">
        <div class="stat-figure text-accent">
            <i class="fas fa-exclamation-triangle text-3xl"></i>
        </div>
        <div class="stat-title">Sự cố (30 ngày)</div>
        <div class="stat-value text-accent">{{ su_co_gan_day|intcomma }}</div>
        <div class="stat-desc">Tổng số sự cố được báo cáo</div>
    </div>
    
    <div class="stat bg-base-100 shadow rounded-box">
        <div class="stat-figure text-info">
            <i class="fas fa-calendar-check text-3xl"></i>
        </div>
        <div class="stat-title">Ca trực hôm nay</div>
        <div class="stat-value text-info">{{ ca_truc_hom_nay|intcomma }}</div>
        <div class="stat-desc">Tổng số ca đã được phân công</div>
    </div>
</div>

<div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mt-6">
    
    <div class="xl:col-span-2 card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">Hoạt động 7 ngày qua</h2>
            <div class="h-96"> <canvas id="activityChart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">Sự cố gần đây</h2>
            <div class="overflow-x-auto">
                <table class="table">
                    <tbody>
                    {% for sc in cac_su_co_moi %}
                        <tr>
                            <td>
                                <div class="font-bold">{{ sc.tieu_de }}</div>
                                <div class="text-sm opacity-70">
                                    {{ sc.ca_truc.vi_tri_chot.muc_tieu.ten_muc_tieu }}
                                </div>
                            </td>
                            <td class="text-right">
                                <span class="badge badge-error badge-sm">{{ sc.get_trang_thai_display }}</span> <br>
                                <span class="text-xs">{{ sc.thoi_gian_bao_cao|timesince }} trước</span>
                            </td>
                        </tr>
                    {% empty %}
                        <tr><td>Không có sự cố nào gần đây.</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Lấy dữ liệu từ Django context mà view đã cung cấp
    const labels = JSON.parse('{{ chart_labels|safe }}');
    const patrolData = JSON.parse('{{ tuan_tra_data|safe }}');
    const incidentData = JSON.parse('{{ su_co_data|safe }}');

    const ctx = document.getElementById('activityChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'bar', // Loại biểu đồ cột
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Lượt Tuần tra',
                        data: patrolData,
                        backgroundColor: 'rgba(59, 130, 246, 0.5)', // Màu xanh dương
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Sự cố',
                        data: incidentData,
                        backgroundColor: 'rgba(239, 68, 68, 0.5)', // Màu đỏ
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1, // Đảm bảo trục Y chỉ hiển thị số nguyên
                            color: 'hsl(var(--bc) / 0.6)' // Lấy màu chữ từ biến CSS của daisyUI
                        },
                        grid: {
                            color: 'hsl(var(--b2) / 0.6)' // Lấy màu lưới từ biến CSS của daisyUI
                        }
                    },
                    x: {
                         ticks: {
                            color: 'hsl(var(--bc) / 0.6)'
                        },
                        grid: {
                            display: false
                        }
                    }
                },
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: 'hsl(var(--bc) / 0.8)' // Lấy màu chữ chú thích
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock extra_js %}