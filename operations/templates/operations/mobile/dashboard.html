{% extends "operations/mobile/base_mobile_revamped.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="p-4 space-y-6">

    <div class="card bg-base-100 shadow-xl">
    <div class="card-body">
        <div class="flex items-center space-x-4"> {# Sử dụng flexbox để căn chỉnh ảnh và thông tin #}
            <div class="avatar">
                <div class="w-16 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
                    <img src="{% if nhan_vien.anh_the %}{{ nhan_vien.anh_the.url }}{% else %}{% static '/img/default-avatar.png' %}{% endif %}" alt="Ảnh thẻ nhân viên">
                </div>
            </div>
            <div>
                {# Lời chào và Tên nằm trên cùng một dòng, hoặc tùy chỉnh font size/weight #}
                <p class="text-lg font-semibold text-base-content/70">{{ loi_chao }} <span class="card-title text-2xl inline">{{ nhan_vien.ho_ten }}</span></p>
                
                {# Mã nhân viên riêng biệt, dễ nhìn #}
                <p class="text-base-content/70 text-lg">Mã NV: <span class="font-semibold">{{ nhan_vien.ma_nhan_vien }}</span></p>
            </div>
        </div>
    </div>
</div>

    {% if error %}
    <div role="alert" class="alert alert-error">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        <span>
            {% for message in messages %}
                {{ message }}
            {% endfor %}
        </span>
    </div>
    {% endif %}

    {% if ca_truc_hien_tai %}
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title text-primary"><i class="fas fa-calendar-check mr-2"></i>Ca trực hiện tại</h2>
            <div class="space-y-2 mt-2 text-base-content">
                <p><span class="font-semibold w-24 inline-block">Mục tiêu:</span> {{ ca_truc_hien_tai.vi_tri_chot.muc_tieu.ten_muc_tieu }}</p>
                <p><span class="font-semibold w-24 inline-block">Vị trí:</span> {{ ca_truc_hien_tai.vi_tri_chot.ten_vi_tri }}</p>
                <p><span class="font-semibold w-24 inline-block">Thời gian:</span> {{ ca_truc_hien_tai.ca_lam_viec.gio_bat_dau|time:"H:i" }} - {{ ca_truc_hien_tai.ca_lam_viec.gio_ket_thuc|time:"H:i" }}</p>
                
                <div class="grid grid-cols-2 gap-4 mt-4 pt-4 border-t border-base-200">
                    <div class="text-center">
                        <p class="font-semibold text-success">Check-in</p>
                        {% if ca_truc_hien_tai.chamcong and ca_truc_hien_tai.chamcong.thoi_gian_check_in %}
                            <p class="text-2xl font-bold font-mono">{{ ca_truc_hien_tai.chamcong.thoi_gian_check_in|time:"H:i" }}</p>
                            <p class="text-xs text-base-content/70">{{ ca_truc_hien_tai.chamcong.thoi_gian_check_in|date:"d/m/Y" }}</p>
                        {% else %}
                            <p class="text-2xl font-bold font-mono text-gray-400">--:--</p>
                            <button onclick="check_in_modal.showModal()" class="btn btn-sm btn-success mt-2">Chấm công vào</button>
                        {% endif %}
                    </div>
                    <div class="text-center">
                        <p class="font-semibold text-error">Check-out</p>
                        {% if ca_truc_hien_tai.chamcong and ca_truc_hien_tai.chamcong.thoi_gian_check_out %}
                            <p class="text-2xl font-bold font-mono">{{ ca_truc_hien_tai.chamcong.thoi_gian_check_out|time:"H:i" }}</p>
                            <p class="text-xs text-base-content/70">{{ ca_truc_hien_tai.chamcong.thoi_gian_check_out|date:"d/m/Y" }}</p>
                        {% else %}
                            <p class="text-2xl font-bold font-mono text-gray-400">--:--</p>
                            <button {% if not ca_truc_hien_tai.chamcong or not ca_truc_hien_tai.chamcong.thoi_gian_check_in %}disabled{% endif %} onclick="check_out_modal.showModal()" class="btn btn-sm btn-error mt-2">Chấm công ra</button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body text-center">
            <i class="fas fa-bed text-4xl text-info mx-auto mb-4"></i>
            <h2 class="card-title justify-center">Ngoài ca trực</h2>
            <p>Bạn hiện không được phân công trong ca trực nào.</p>
        </div>
    </div>
    {% endif %}

    <div class="card bg-base-100 shadow-xl">
        <div class="card-body items-center text-center">
            <h2 class="card-title">Mã QR của bạn</h2>
            <p>Dùng mã này để quét tại các điểm tuần tra.</p>
            <img src="data:image/png;base64,{{ qr_code_base64 }}" alt="QR Code" class="w-48 h-48 mt-2 rounded-lg">
        </div>
    </div>
</div>

{% if ca_truc_hien_tai %}
<dialog id="check_in_modal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg">Xác nhận Check-in</h3>
    <p class="py-4">Vui lòng chụp ảnh selfie tại vị trí để xác nhận chấm công vào ca.</p>
    <form method="post" action="{% url 'operations:check_in' ca_truc_hien_tai.id %}" enctype="multipart/form-data">
        {% csrf_token %}
        {{ checkin_form.as_p }}
        <div class="modal-action">
            <button type="submit" class="btn btn-success">Xác nhận</button>
            <form method="dialog">
                <button class="btn">Hủy</button>
            </form>
        </div>
    </form>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<dialog id="check_out_modal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg">Xác nhận Check-out</h3>
    <p class="py-4">Vui lòng chụp ảnh selfie tại vị trí để xác nhận chấm công ra ca.</p>
    <form method="post" action="{% url 'operations:check_out' ca_truc_hien_tai.id %}" enctype="multipart/form-data">
        {% csrf_token %}
        {{ checkout_form.as_p }}
        <div class="modal-action">
          <button type="submit" class="btn btn-error">Xác nhận</button>
          <form method="dialog">
            <button class="btn">Hủy</button>
          </form>
        </div>
    </form>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>
{% endif %}

{% endblock %}